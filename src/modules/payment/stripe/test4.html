<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment</title>
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <div class="payment-container">
        <h1>Make a Payment</h1>

        <!-- Service Tier Selection -->
        <div>
            <label for="service-tier">Select Service Tier</label>
            <select id="service-tier" name="service_tier_id">
                <!-- Options will be dynamically populated here -->
            </select>
        </div>

        <!-- Addons Section -->
        <div id="addons-section">
            <h2>Add-ons</h2>
            <!-- Addons will be dynamically populated here -->
        </div>

        <!-- Amount Display (Price) -->
        <div>
            <label for="amount">Amount (USD)</label>
            <input type="text" id="amount" name="amount" readonly>
        </div>

        <!-- Payment Button -->
        <button id="submit-btn">Pay</button>

        <!-- Stripe Elements -->
        <div id="card-element"></div> <!-- Stripe Card Element -->

        <!-- Error Display -->
        <div id="card-errors" role="alert"></div>

        <!-- Success Modal -->
        <div id="success-modal" style="display:none;">
            <h2>Payment Successful!</h2>
            <button id="close-modal">Close</button>
        </div>
    </div>

    <script>
        // Initialize Stripe
        const stripe = Stripe('YOUR_STRIPE_PUBLISHABLE_KEY');  // Replace with your publishable key
        const elements = stripe.elements();
        const cardElement = elements.create('card');
        cardElement.mount('#card-element');

        // Get DOM elements
        const submitBtn = document.getElementById('submit-btn');
        const amountInput = document.getElementById('amount');
        const serviceTierSelect = document.getElementById('service-tier');
        const cardErrors = document.getElementById('card-errors');
        const addonsSection = document.getElementById('addons-section');
        const successModal = document.getElementById('success-modal');
        const closeModal = document.getElementById('close-modal');

        let selectedServiceTierId;
        let selectedServicePrice;

        // Fetch service tiers and populate dropdown
        async function fetchServiceData() {
            const response = await fetch('http://localhost:4000/api/services');  // Replace with your actual API endpoint
            const data = await response.json();
            
            // Dynamically populate the service tiers dropdown
            const serviceTierSelect = document.getElementById('service-tier');
            data.service_tiers.forEach(tier => {
                const option = document.createElement('option');
                option.value = tier.id;
                option.textContent = `${tier.name} - $${tier.price}`;
                serviceTierSelect.appendChild(option);
            });

            // Add event listener to update the displayed price and selected tier
            serviceTierSelect.addEventListener('change', async () => {
                selectedServiceTierId = serviceTierSelect.value;
                const selectedTier = data.service_tiers.find(tier => tier.id === selectedServiceTierId);
                selectedServicePrice = selectedTier.price;

                // Update amount input with selected tier's price
                amountInput.value = selectedServicePrice;

                // Populate addons for the selected tier
                populateAddons(data.addons);
            });

            // Set default selection
            serviceTierSelect.value = data.service_tiers[0].id;
            selectedServiceTierId = data.service_tiers[0].id;
            selectedServicePrice = data.service_tiers[0].price;
            amountInput.value = selectedServicePrice;

            // Populate addons for the first tier
            populateAddons(data.addons);
        }

        // Populate Addons Section
        function populateAddons(addons) {
            addonsSection.innerHTML = ''; // Clear previous addons
            addons.forEach(addon => {
                const addonDiv = document.createElement('div');
                addonDiv.innerHTML = `
                    <input type="checkbox" id="addon-${addon.id}" data-price="${addon.price}">
                    <label for="addon-${addon.id}">${addon.name} - $${addon.price}</label>
                `;
                addonsSection.appendChild(addonDiv);

                // Add event listener to handle addon selection
                document.getElementById(`addon-${addon.id}`).addEventListener('change', updateAddonPrice);
            });
        }

        // Update total price when addons are selected/deselected
        function updateAddonPrice() {
            let totalAmount = selectedServicePrice;

            // Calculate addon price
            document.querySelectorAll('#addons-section input[type="checkbox"]:checked').forEach(checkbox => {
                totalAmount += parseFloat(checkbox.getAttribute('data-price'));
            });

            // Update amount input
            amountInput.value = totalAmount;
        }

        // Handle form submission
        submitBtn.addEventListener('click', async function() {
            const amount = parseFloat(amountInput.value) * 100;  // Convert to cents

            try {
                // Step 1: Call backend to create PaymentIntent
                const response = await fetch('http://localhost:4000/api/payment/pay', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        service_tier_id: selectedServiceTierId,
                        amount: amount,
                        currency: 'usd',
                    })
                });

                const data = await response.json();
                const clientSecret = data.clientSecret;

                if (!clientSecret) {
                    throw new Error('Failed to get client secret');
                }

                // Step 2: Confirm the payment with Stripe
                const { error } = await stripe.confirmCardPayment(clientSecret, {
                    payment_method: {
                        card: cardElement,
                    }
                });

                if (error) {
                    cardErrors.textContent = error.message;
                } else {
                    // Payment was successful
                    successModal.style.display = 'block';  // Show success modal
                }
            } catch (error) {
                cardErrors.textContent = error.message;
            }
        });

        // Close the success modal
        closeModal.addEventListener('click', () => {
            successModal.style.display = 'none';
        });

        // Handle real-time validation errors
        cardElement.on('change', function(event) {
            if (event.error) {
                cardErrors.textContent = event.error.message;
            } else {
                cardErrors.textContent = '';
            }
        });

        // Initialize and fetch service data
        fetchServiceData();
    </script>
</body>
</html>
